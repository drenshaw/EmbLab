

\documentclass[openany,11pt,fleqn]{book} % Default font size and left-justified equations

\input{structure} % Insert the commands.tex file which contains the majority of the structure behind the template
\usepackage{float}

\usepackage{amsmath}

\usepackage{listings} 
\lstset
{ 
    language=C,
    basicstyle=\ttfamily,
    columns=fullflexible,
    keepspaces=true,
    numbers=none,
    stepnumber=1,
    showstringspaces=false,
    tabsize=1,
    breaklines=true,
    breakatwhitespace=false,
    keywordstyle=\color{blue!80!black},
    stringstyle=\color{red!80!black},
    commentstyle=\color{green!40!black},
    morecomment=[l][\color{magenta!80!black}]{\#}
}

\usepackage{caption}
\captionsetup[figure]{font=small,skip=10pt}

%\usepackage{enumitem}
%\setlist{noitemsep} % or \setlist{noitemsep} to leave space around whole list


%%%%% May be too harsh to prevent paragraph breaks across pages! 
%\interlinepenalty 10000
\widowpenalties 1 10000
\raggedbottom


\newcommand{\ilcode}[1]{
    %\vspace{0.5pt}
    \smallskip
    \colorbox{gray!20!white}{
        \centering
        \parbox{\linewidth-2\fboxsep}{
            \lstinline@#1@
        }
    }
    %\vspace{0.5pt}
}

\newcommand{\code}[3]{
    \begin{figure}[]
        \colorbox{gray!20!white}{
            \parbox{\linewidth-2\fboxsep} {
                \centering 
                \lstinputlisting[language=C]{#1}
            }
        }
        \caption{#2}
        \label{#3}
    \end{figure}
}


%\begin{figure}[]
%    \centering\includegraphics[width=0.75\textwidth]{}
%    \caption{}
%    \label{}
%\end{figure}

\usepackage{textcomp}
\usepackage{wrapfig}
\usepackage{float}

\usepackage{silence} % http://ctan.org/pkg/silence
\ErrorFilter{textcomp}{Symbol \textrightarrow not provided}

% Disable paragraph indentation globally since template was indenting some and not others. (looked terrible)
%\setlength{\parindent}{0pt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%                                                                                         %%%%
%%%%       Chapter 3: Timers, PWM and GPIO Alternate Functions                               %%%%
%%%%                                                                                         %%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\setcounter{chapter}{2} % Manually adjust chapter counter to number before desired chapter heading

\begin{document}
	
\chapterimage{chapter_head_2.png} % Chapter heading image
%\tableofcontents
\chapter{Timers, PWM and GPIO Alternate Functions}

\section{Introduction to Timers}
The last lab used the SysTick timer to generate periodic interrupts. The SysTick is a simple peripheral with a 24-bit down-counting register that decrements every processor clock cycle. Reaching zero on this counter triggers an interrupt. The primary purpose of the SysTick timer is to generate a stable system ``tick'' or timing reference signal. 

We use this reference signal to indicate the passage of a unit of time. Some common places to use the SysTick are within the HAL delay libraries and in the context switcher of real-time operating systems. 

Why is accurate timing important? Although a processor moves along the applications code in units of the clock cycle, it is difficult and inefficient to measure time simply by counting instruction cycles without dedicated hardware timers. The need for accurate timing stems from the fact that many embedded systems require specific timings or schedules for communications and while interacting with the physical world.

At their core, all timers are simple registers which increment or decrement whenever a trigger signal occurs. It is this basic functionality that we build the capability to generate hardware interrupts like the SysTick; we use the Systick here since it is merely the simplest of the onboard timer peripherals.
    
\section{\color{blue}Prelab Questions}\index{Prelab Questions}
\begin{question}[Prelab 3]
	Please answer the following questions and hand in as your prelab for Lab 3.
	% The section locations for each question needs renumbering in respect to the section to which it refers
	\begin{enumerate}
		\item List two things you can learn from a peripheral's functional description in the peripheral reference manual?
		\item What is the title of the first sub-section in the functional description of timers 2 and 3?
		\begin{itemize}
			\item Not mentioned in the lab manual; look it up!
		\end{itemize}
		\item What is the purpose of the Prescaler (PSC) register?
		\item What is the purpose of the Auto-Reload (ARR) register?
		\item What is the purpose of the Capture/Compare (CCRx) register while the timer is operating in Output Compare mode? 
		\item What does the duty-cycle of a PWM signal represent?
		\item What is the purpose of the Alternate Function mode for a GPIO pin? 
		\item In what document can you find the documentation for what GPIO pins have which alternate functions?
	\end{enumerate}
\end{question}
    
    \subsection{Systick vs Peripheral Timers}
     Because the SysTick peripheral has a very simple purpose\textemdash generate periodic interrupts\textemdash it doesn't offer any features that make it useful for more complicated tasks. 
     
     In contrast, other peripheral timers within the STM32F0 are very useful in various tasks the user application requires; they are therefore relatively complicated devices with a large variety of features. Figure \ref{block_timers} shows the block diagram for general-purpose timers 2 \& 3 in the STM32F072.  

        \begin{figure}[]
            \centering\includegraphics[width=\textwidth]{block_timers}
            \caption{Block diagram of timers 2 \& 3}
            \label{block_timers}
        \end{figure}
        
        The three main features that peripheral timers offer over simpler devices such as the SysTick are:
        \begin{enumerate}
            \item \textbf{Selectable and Prescalable Clock Sources} -- Many peripheral timers can choose between multiple sources to use for their clock signal and can divide the input frequency by arbitrary integer values. 
            \item \textbf{Generate Interrupts at Multiple Conditions} -- Many peripheral timers can generate interrupts at arbitrary counter values.
            \item \textbf{Directly Modify GPIO Pins} -- Many peripheral timers can directly set or capture GPIO pin states to measure or generate digital signals.  
        \end{enumerate}
        
	
    
    \subsection{Timers in the STM32F072}
        %(Show table of timers in the STM32F072)
        \begin{figure}[]
            \centering\includegraphics[width=\textwidth]{avaliable_timers}
            \caption{STM32F072RB hardware timers}
            \label{avaliable_timers}
        \end{figure}
        
        
        Figure \ref{avaliable_timers} shows the timers available in the specific chip used in the labs. When deciding on a timer to use for an application, it is helpful to understand their capabilities and limits to determine their suitability for the task. A brief breakdown of the information in figure \ref{avaliable_timers} is as follows:
        
        \begin{itemize}
            \item \textbf{Timer Type} -- The STM32F0 has multiple classes of timers; these serve as indicators of the appropriate uses for the peripheral. An advanced control timer offers additional and more complex operating modes than a general-purpose one. 
            \item \textbf{Timer} -- These abbreviated names identify the timers in the documentation; they are also the defined names for the timer structures in the supporting peripheral header files. 
            \item \textbf{Counter Resolution} -- This indicates the size of the hardware counter within the timer; e.g., a 16-bit timer can only count to $2^{16}$ values before overflowing and wrapping back to zero. 
            \item \textbf{Counter Type} -- Typically the hardware counter in a timer counts upwards with each clock cycle; wowever, more advanced timers also can count downwards from a value or to change direction whenever reaching the limit values automatically. 
            \item \textbf{Prescaler Factor} -- The prescale factor allows the timer to pre-divide the input clock to a slower frequency; the timers within the STM32F0 have the ability to divide the input clock by arbitrary integer factors between 1 and $2^{16}$.
            \item \textbf{DMA Request Generation} -- Many peripherals have the ability to move data between peripheral registers and system memory without using the processor in a process known as Direct Memory Access (DMA).
            \item \textbf{Capture/Compare Channels} -- Most timers have the ability to modify GPIO pins without using the GPIO peripheral; the capture/compare system in a timer generates and measures digital signals on an external pin. 
            \item \textbf{Complementary Outputs} -- The capture/compare circuity in some timers can generate complementary or opposing outputs on two GPIO pins. 
        \end{itemize}

\section{Using the Timer Documentation}
    At this point, the peripherals used in the labs are reaching the level of complexity that the lab manual won't provide enough information to complete the lab assignments without the datasheets and manuals. Instead, the lab manuals will attempt to provide an overview of the different modes of operation and their relevant registers within the peripheral; you will need to supplement that information with information within the datasheets.

    Figure \ref{avaliable_timers} displays the set of available timers and indicated their characteristics. For the remainder of this lab manual, we will focus on the documentation materials for TIM2 \& TIM3. 
    
    Timers 2 \& 3 are the moderately-advanced versions of the general purpose timers in the STM32F0. Although not as complex as the advanced control timer 1, they feature additional modes and more output channels. All the timers in the STM32F0 have a nearly identical interface, so reading through the documentation of the more complex peripherals should make interfacing with one of the simpler devices easier. 
    
    \subsubsection{Organization of Peripheral Documentation}
    Each section of the peripheral reference manual follows a similar organization regardless of the peripheral which it discusses; they begin with a brief introduction of the purpose and features of the peripheral, followed by a block diagram showing the basic architectural design of the hardware. 
    
    The section titled \textit{Functional Description} is the most helpful piece of material used when figuring out a new peripheral; the functional description of a peripheral provides the following information:
    
    \begin{itemize}
        \item Explanation of the purpose of each operating mode 
        \item Basic theory of operation 
        \item Relevant registers and configuration options 
        \item Summarized configuration information
        \begin{itemize}
            \item Typically the summary provides generic steps for peripheral configuration. 
            \item These provide a foundation when searching the register documentation for additional details. 
        \end{itemize}
        \item Summary of the output data produced
        \begin{itemize}
            \item Indicates where data is written for application use.
            \item Typically includes figures and graphs depicting peripheral operation.
        \end{itemize}
    \end{itemize}

    After the functional description, the reference manual documents each of the peripheral's registers in detail. Assuming that you have read and understand the information within the functional description section, you will spend the majority of your time using the register maps and bit descriptions to configure the peripheral into the desired behavior. 

%    The following sections will attempt to provide a summarized version of the important information in the functional description for the timer 2 \& 3 peripherals. 
%        Their documentation is 65 pages long... (and dense)
%    
%    Reference manual documentation goes in this format:
%        Basic information on what peripheral does
%        Details and architectural block diagrams
%        Documentation of the different modes
%        These usually have some specific background info
%        Summarized information on how to configure the mode
%            Gives generic steps, will need to carefully read the register documentation
%        Summarized information on data produced 
%            describe where produced data is written
%            Includes figures depicting operation
%    
%    This manual will document the purpose of the base registers as they are used in each mode
%        May also indicate groups of control bits that pertain to the configuration or operation 	

\section{\color{orange}Using Timers to Generate Interrupts and Events} \label{timer_interrupts}

    One of the most basic uses of a timer is to generate periodic interrupts. Unlike the SysTick timer which is typically configured once to a specific base unit of time, the peripheral timers are available to use with arbitrary and varying timing periods. Because their input prescaler can divide the input clock by arbitrary integer values, it becomes possible to generate very long timer periods or match strange timing requirements that aren't multiples of the system clock. Section 18.3 \textit{TIM2 and TIM3 Functional Description} of the peripheral reference manual documents the following sections in greater detail. 
    
    Three registers form the core operations of a timer peripheral. 
    \subsubsection{Timer Counter Register (CNT)}
    The CNT register holds the current value of the counter in the timer. Its size depends on the counter resolution (16/32-bit) indicated in the timer's documentation. Although this register automatically updates as the timer operates it is possible to read and edit its value manually. Reading from or writing to the value of the CNT register is a useful method of counting time or modifying the timer's operation. 
    \subsubsection{Timer Prescaler Register (PSC)}
    The PSC register divides the input clock frequency to the timer. Its value is 0-indexed, meaning that a value of 0 in the PSC register divides the clock source by 1 (no frequency scaling); likewise, a value of 1 in the PSC register divides the clock source by 2 and causes the timer to count at half the clock frequency. The PSC can divide the input clock by any integer value that fits in its 16-bit width.  
    \subsubsection{Timer Auto-Reload Register (ARR)}
     Although a timer has a physical hardware size to its counter register, you may set a lower top limit; the value in the ARR register is the trigger point at which the timer resets and begins to count a new period. The actual behavior of the timer depends upon its counting mode. We will discuss this more in a later section. 

    
    \subsection{\color{orange}Basic Timer Operation}
    
    A timer operates under three different counting modes: up, down, and center-aligned (up/down). Figure \ref{count_modes} shows a graphical representation of each of the counting modes.  
    
    \begin{itemize}
        \item \textbf{Upcounting Mode} --  Starting at 0, the timer counts upwards to the auto-reload value in the ARR register, after which the counter resets back to 0 and begins counting anew. 
        \item \textbf{Downcounting Mode} -- The timer starts at the auto-reload value and counts downwards until reaching 0; it resets back to the ARR value when it reaches 0.
        \item \textbf{Center-aligned Mode (up/down counting)} -- The timer starts by counting upward from 0 until it reaches the auto-reload value, at which point the counting direction reverses and counts downwards towards zero. The process repeats again by counting upward.
    \end{itemize}

    \begin{figure}[]
        \centering\includegraphics[width=0.75\textwidth]{count_modes}
        \caption{Timer counting modes and update interrupts}
        \label{count_modes}
    \end{figure}

    \subsubsection{Basic Timer Interrupts}
    
    Regardless of the counting mode, an \textit{Update Event} (UEV) signals when the timer reaches a limit and resets to a new value. Additionally, center-aligned counters can trigger update events whenever the timer changes to a specific direction. 
    
    The UEV is one possible interrupt source in a peripheral timer; typically this source generates periodic interrupts, but with a very flexible and potentially long duration period.
    
    \subsubsection{Configuring Basic Timer Settings}
    In addition to the three main timer registers, we have four control registers to set timer parameters; these enable the timer, set the counting direction, enable the UEV interrupt, and clear the pending interrupt flag in a handler. 
    
    \begin{itemize}
        \item \textbf{Control Registers 1 \& 2 (CR1 \& CR2)} -- These hold the primary configuration options of the timer; for example, before the timer can operate we must enable it using the \textit{Counter Enable} (CEN) bit. 
        \item\textbf{DMA/Interrupt Enable Register (DIER)} -- Controls the possible interrupt sources in the timer.
        \item\textbf{Status Register (SR)} -- Contains pending flags that interrupt handlers must clear.
    \end{itemize}

    \subsection{\color{orange}Selecting Timer Frequency and Interrupt Period}	
    The peripheral timers in the STM32F0 may use a several different sources for their clock input. 
    \begin{itemize}
        \item\textbf{Internal Peripheral Clock} -- This is the most common clock source and is determined by the clock distribution system. In our toolchain, the STMCubeMX program sets this frequency to 8Mhz by default. 
        \item\textbf{External Clock Pin} -- Many timers have the ability to use an external clock source provided by an input pin; this source may have a unique frequency or higher accuracy than the processor clock.
        \item\textbf{Internal Trigger Inputs} -- Some peripherals can generate trigger events that are visible throughout the device; this mode can chain timers together or count events produced by other types of peripherals.
    \end{itemize}
 
 
    \subsubsection{Using the Prescaler}
      
        The primary purpose of the timer prescaler is to determine the base unit of time that a single ``tick'' represents. Consider a timer operating at 8Mhz: the period between each update of the timer's value would be one-eighth of a micro-second, or 125ns. While you could use this unit of time as a basis for counting longer periods, it may not be convenient. 
        
        The prescaler allows us to convert the input clock frequency into more practical units. For example, if we wanted to count something with a duration in milliseconds, the prescaler could divide the input 8 Mhz clock by a factor of 8000, resulting in a base unit of 1 ms between each timer count. 
        
        Within the timer hardware, the value of the prescaler register (PSC) is 0-indexed, meaning that the value written to the PSC register should always be one less than the desired prescaler value; consequently, the default value of 0 in the PSC register divides by 1, performing no frequency division.  

    \subsubsection{Calculating Register Values}
        Using both the prescaler and auto-reload register makes configuring a timer to a specific period trivial. First, determine the unit of time of your desired period, and use the prescaler to convert the timer's base unit to either the same or a convenient multiple/divisor. Then use the auto-reload register to count the desired number of time units to make the target period. 
        
        If you attempt to generate a very long period, you may have to use larger or more granular base units because the hardware size of the timer may be insufficient to attain the counter value; in many cases, however, we may use small prescaler values to achieve finer resolution when counting.
        The following equations may be helpful when selecting prescaler and auto-reload values from a target period or frequency:
        
        %\begin{displaymath}
        \begin{align*}
            & T_{TARGET} = \frac{(PSC-1)}{f_{CLK}} * ARR & & f_{TARGET} = \frac{f_{CLK}}{(PSC-1) * ARR}\\[1em]
            & PSC = \frac{f_{CLK}}{ARR * f_{TARGET}}-1 & & ARR = \frac{f_{CLK}}{(PSC+1) * f_{TARGET}}
        \end{align*}
        %\end{displaymath}
        	
            
        \begin{center}
            \begin{example}[Calculating ARR and PSC Values] 
                \label{example1}
            For this example, we will set a timer to produce an interrupt at 20Hz assuming that the timer's input clock is 8Mhz. \\
            
            A target frequency of 20Hz results in a 50ms period; we then divide the 8Mhz clock by 8000 to reduce our timer's frequency to 1kHz. Counting at 1 kHz gives us 1 ms per timer count, so we need 50 counts to reach our target period. We can achieve our timing scheme by setting the PSC to 7999, the ARR to 50, and enabling the UEV interrupt in the control registers.  
            \end{example}
        \end{center}
        
    \begin{exercise}[Using Timer Interrupts]
        \label{ex1}
        
        In this exercise, you'll set up a timer such that the update event (UEV) triggers an interrupt at a specific period. Timer peripherals allow for greater flexibility in choosing an interrupt period over manually counting in the SysTick handler. To complete this exercise, carefully review the control register maps in the peripheral reference manual to determine the proper option bits to set and reset. 
        
        \begin{enumerate}
            \item Enable the timer 2 peripheral (TIM2) in the RCC.
            \begin{itemize}
                \item This lab will use timers 2 and 3; while all of the timer peripherals can produce interrupts, their configuration registers often have slight differences. 
            \end{itemize}
            \item Configure the timer to trigger an update event (UEV) at 4 Hz.
            \begin{itemize}
                \item \textbf{The default processor frequency of the STM32F072 is 8 MHz. Use this value when calculating the timer parameters.}
                \item A typical approach is to set the timer's base frequency and the target period into the same units. 
                \begin{itemize}
                    \item See example \ref{example1}, and use the prescaler (PSC) register. 
                \end{itemize}
                \item Once the timer and target period are in similar units, set the auto reload register (ARR) to count the number of units to reach the target. 
                \begin{itemize}
                    \item Pay attention to the size (in bits) of the timer. For example, a 16-bit timer can only count up to 65535. If your target ARR is outside of that range, you'll need to adjust the prescaler (change units) to scale the ARR appropriately. 
                \end{itemize}
            \end{itemize}    
            \item Configure the timer to generate an interrupt on the UEV event.     
                \begin{itemize}
                    \item Use the DMA/Interrupt Enable Register (DIER) to enable the update interrupt. 
                \end{itemize}
             \item Configure and enable/start the timer
             \begin{itemize}
                 \item Although the RCC enabled the timer's clock source, the timer has its own enable/start bit in the control registers. 
                 \item Note that you should not enable a timer until you've finished setting all the basic parameters and options. This is different than the RCC enable, which you should always enable first!)
             \end{itemize}
             \item Set up the timer's interrupt handler, and enable in the NVIC.
             \begin{itemize}
                \item The timer will only have a single generic interrupt reserved in the vector table (not a specific interrupt about the UEV). 
                \item Look for an interrupt containing the name of the timer you are using. 
            \end{itemize}
            \item Toggle between the green (PC8) and orange (PC9) LEDs in the interrupt handler. 
            \begin{itemize}
                \item Remember to initialize the LED GPIO pins in your main function. 
                \item To get the alternating flash pattern, set one of the LEDs active in the GPIO initialization.
                \item Don't forget to clear the pending flag for the update interrupt in the status register. 
            \end{itemize}
            \item Compile and load the application onto the Discovery board.
        \end{enumerate}
        
    \end{exercise}

\section{Using Timers to Generate or Measure Signals}
The basic operation modes of a timer allow for a very flexible method of generating interrupts by modifying the timer's frequency and top value. However, the timers in the STM32F0 are also capable of generating and measuring physical waveforms by directly interfacing with GPIO pins; these features are possible with the Capture/Compare Unit in the timer. 

The timer has two additional registers capture/compare mode; figure \ref{avaliable_timers} indicated how many capture/compare channels are available within each timer. Each capture/compare channel functions independently, but they share identical interfaces within the timer.  
\begin{itemize}
    \item \textbf{Capture/Compare Registers (CCRx)} -- This register holds capture/compare data; its specific use depends on the selected mode.
    \item \textbf{Capture/Compare Mode Registers (CCMRx)} -- Selects between capture and compare modes, and configures their operation.
    \item \textbf{Capture/Compare Enable Register (CCER)} -- Enables/disables the capture/compare channel outputs.
\end{itemize}

The three basic modes for the capture/compare channels are input capture mode, output compare mode, and pulse-width modulation (PWM) mode. Although these modes are primarily for interfacing with their associated GPIO pins, they can generate interrupts on their respective trigger conditions. 			
    
    \subsection{Input Capture Mode}
    Input capture mode latches the current value of the timer's counter into the appropriate CCRx register whenever its connected GPIO pin state changes; this mode allows very accurate measurements of elapsed time between changes on that pin. 
    
    Similar to the EXTI, the input capture hardware can trigger on either the rising or falling edges of a signal; the input capture system, however, has a configurable digital filter to remove glitches and other noise from the signal. The primary purpose of the input capture mode is to measure precise timing-based signals such as those from a single-wire serial bus or a motor encoder.  

    
    \subsection{Output Compare Mode}
        The output compare mode modifies the output of a GPIO pin whenever the timer's counter matches the value stored in the CCRx register. Depending on the configuration, an output compare channel can set, clear, or toggle its pin on a counter match. 
        
        The output compare mode can create arbitrary digital waveforms on the output; generally the ARR register is set to provide a constant period to the timer, and the user's application produces the desired output by modifying the CCRx register while the timer is running. Figure \ref{ocomp_mode} shows an up-counting timer toggling an output compare pin on every match of the CCRx register. 

        \begin{figure}[]
            \centering\includegraphics[width=0.75\textwidth]{ocomp_mode}
            \caption{Output Compare mode with pin toggle on compare match.}
            \label{ocomp_mode}
        \end{figure}
    
%        The capture compare mode register can be changed on-the-fly, moving the event point. This is often used in PWM mode.
    
    \subsection{Pulse-Width Modulation (PWM) Mode}
    The pulse-width modulation mode of the capture/compare system is a more advanced form of output compare; although pulse-width modulation (PWM) is ultimately a simple concept, it can be confusing at first. 
    
    \subsubsection{\color{orange}About Pulse-Width Modulation}
    PWM is a method of approximating an analog signal using only digital hardware; it operates by using a high-frequency rectangular-wave signal where every period is a ratio of on and off time, known as the \textit{duty-cycle}, and represents an analog voltage ranging between the low and high voltages of the digital signal. 
    
    For example, a period of the rectangular wave with a 50\% duty cycle would spend half the period at the high (on) output voltage and the other half at the low (off). A period with 0\% duty cycle remains low for the entire duration, and one with a 100\% duty cycle remains high. Let's see how the duty cycle of a PWM signal represents an analog voltage by considering the average voltage of the digital signal over the entire period. A digital waveform that was high (on) for half of the cycle and low (off) for the other half would average to one-half of the original voltage.  
    
    Naturally, the concept of PWM does not make sense at low frequencies; it would just appear as a series of pulses; at high frequencies, however, many physical systems cannot respond quickly enough to shut-off or turn-on with each output transition. This is the basis of a mechanical and electrical low-pass filter which averages or smooths out the high-frequency transitions of the PWM signal into an approximated analog voltage.
    
    PWM has a wide range of uses; some common implementations are in audio, light dimming, and motor speed control. Figure \ref{pwm_sine} shows how a digital PWM signal approximates an analog sine-wave. 

    \begin{figure}[]
        \centering\includegraphics[width=0.75\textwidth]{pwm_sine}
        \caption{PWM approximation of an analog sine-wave.}
        \label{pwm_sine}
    \end{figure}
    
    \subsubsection{Operation of Capture/Compare PWM Mode}
    The PWM mode operates almost exactly as the output compare mode of the timer; the difference is that the output pin state also changes whenever the timer counter resets to begin a new period. There are different modes of PWM that the capture/compare system can generate: figure \ref{pwm_pin} demonstrates one of the possible PWM modes. In the mode from figure \ref{pwm_pin}, the output pin begins the PWM period at a low state and goes high once the timer's counter matches the CCRx register; this output resets to low again when the next period starts. The location of the CCRx value relative to the ARR register value determines the overall ratio of on/off (duty cycle). 
   
   The important thing to note about PWM is that the signal has both a duty-cycle \textit{and} frequency: the timer's frequency and the ARR register determine the frequency of the PWM, and the ratio of the CCRx and ARR registers sets the duty cycle. The frequency of the PWM signal generally is irrelevant to the approximated analog voltage, but it must remain sufficiently high so that the physical system can't directly respond to the transitions in a PWM period. 
   



\begin{exercise}[Configuring Timer Channels to PWM Mode]
    \label{ex2}
    This exercise sets up a PWM output to dim the LEDs on the Discovery board: changing the waveform's duty cycle controls the apparent brightness of the LED. For this exercise you will be using capture/compare channels 1 \& 2 of timer 3. 
    
    \begin{enumerate}
        \item Enable the timer 3 peripheral (TIM3) in the RCC.
        \item The timer's update period determines the period of the PWM signal; configure the timer to a UEV period related to 800 Hz (T = 1/f).  
        \begin{itemize}
            \item Follow the previous exercise as a template, but do not enable/start the timer.
            \item Set the prescaler to a reasonable range of counter values between zero and the top limit; otherwise your timer will be too granular to be able to make fine adjustments to the duty-cycle of the PWM.
            \item Do not enable the update interrupt or set up the handler: we will not be using interrupts for this part.
        \end{itemize}
        \item Use the Capture/Compare Mode Register 1 (CCMR1) register to configure the output channels to PWM mode.
        \begin{enumerate}
            \item The CCMR1 register configures channels 1 \& 2, and the CCMR2 register for channels 3 \& 4.
            \item Examine the bit definitions for the CC1S[1:0] and CC2S[1:0] bit fields; ensure that you set the channels to output. 
            \item Examine the bit definitions for the OC1M[2:0] bit field; set output channel 1 to \textit{PWM Mode 2}.
            \item Use the OC1M[2:0] bit field to set channel 2 to \textit{PWM Mode 1}.
            \begin{itemize}
                \item The OC2M bits operate identically to the OC1M and so have the same documentation. 
                \item You will see the difference between the different PWM modes in a later exercise.
            \end{itemize}
            \item Enable the output compare preload for both channels.
        \end{enumerate}
        \item Set the output enable bits for channels 1 \& 2 in the CCER register.
        \item Set the capture/compare registers (CCRx) for both channels to 20\% of your ARR value.
    \end{enumerate}
\noindent The previous sections mention that the frequency of a PWM signal isn't nearly as important as the duty-cycle, provided that the frequency is high enough; this is true for dimming LEDs, although the lower-limit isn't how fast the LED can respond to the electrical signal, but how fast the human eye can distinguish separate blinks.

When both the light and viewer are stationary, the human eye has difficulty seeing the blinking transitions past 70 Hz; many people, however, may see noticeable flicker in moving lights even above 500 Hz. You'll therefore be using 800 Hz as the base frequency for the PWM. 

\end{exercise}

     \begin{figure}[!b]
    \centering\includegraphics[width=0.75\textwidth]{pwm_pin}
    \caption{Edge-aligned PWM mode and output pin state.}
    \label{pwm_pin}
\end{figure}

\section{Configuring GPIO pins to Alternate Function Mode} \label{alternate_mode}

If each GPIO peripheral controls the output state of its pins in normal operating conditions, how does another peripheral such as a timer modify a pin's state? The answer lies within one of the four available pin modes in the GPIO MODER register. In the first lab we used the Input and Output modes of a GPIO pin; two others are available that we haven't yet discussed: these are the Analog and Alternate Function modes. Allowing a pin to connect directly to internal peripherals of the STM32F0 is the purpose of the alternate function mode. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Unlike the EXTI which has the SYSCFG multiplexers, peripherals such as the timers do not have access to arbitrary pins; instead, the peripheral's internal signals have hardwire connections to only a handful of pins scattered around the chip. 

The GPIO alternate function system affords the user different options when selecting pins for a peripheral. Due to the large number of possible peripheral signals in relation to the number of pins, many pins have multiple alternate functions that they connect across multiple peripherals. Although a pin may have multiple functions, it may only control on at a time. Using many peripherals may require carefully planning which pins to use to ensure that all of them can reach one of their limited output pins.  

%    What is Alternate Function Mode?
%    Need to tell the GPIO hardware to allow the timer to directly control the pin output state
%    Connecting a pin to an internal peripheral of the device is called "Alternate Function Mode"
%    In the STM32F0s most peripherals are directly connected to specific sets of pins. 
%        Not like the EXTI which has the SYSCFG muxes to everywhere
%        While you can't assign an internal signal to an arbitrary pin, they do give you a few pin options to choose.
%        Most GPIO pins have multiple possible alternate functions, need to look up. 
%    
%    Use chip datasheet (Pinouts and pin descriptions section)
    
    \subsection{Finding Available Pins on a Device Package}
    
    Alternate function assignments are specific to the STM32F0 device used. This means that the information on pin alternate functions is found within the device datasheet and not the peripheral reference manual.
    
    Open the STM32F072xB datasheet and navigate to Section 4 \textit{Pinouts and Pin Descriptions}. This section provides documentation on all of the chip packages available for the device. It also provides tables with pinout details, including alternate functions.
    
    Navigate past the package maps until you find Table 13 \textit{STM32F072x8/xB pin definitions}. This table provides pin number to pin name mappings, pin characteristics and limitations, and available alternate functions. Figure \ref{chip_pins} shows an annotated portion of table 13. 
    
    \subsubsection{Physical Pin Numbering}
    Beginning from the left-side of the table, the first set of column headers list the different packages available for the chip. These columns provide the physical pin numbering of the chip for that specific package. The STM32F072xB on the Discovery board we are using has a 64-pin low-quad-flat-pack (LQFP64) chip package; this column has been highlighted in orange. Notice that the lowest two rows do not have a number and are highlighted in red, this indicates that the specific pin on that row does not physically exist in the given package. 
    
    \begin{warning}
        When selecting pins, make sure they exist physically on the device package you are using! All GPIO outputs exist on the silicon die of the STM32F0. However, there aren't enough pins available on every type of chip packaging, and they are not all wired out.
    \end{warning}

    \subsubsection{Pin Name and Characteristics}
    The next column titled ``Pin Name'' (highlighted in green) gives the conventional pin name which indicates the specific GPIO port and location within the peripheral registers. When designing a hardware circuit around an STM32F0 device the information in this table is required to map pin names used in software to physical pin numbers on the chip. 
   
   The next three columns give information about the input/output circuitry driving the pin. The definitions of the acronyms used are listed in Table 12. 
    
    \subsubsection{Alternate and Additional Functions}
    The ``Alternate Functions'' column (highlighted in blue) lists the various peripheral signals available for the pin. Once configured into alternate function mode the GPIO peripheral connects one of these signals. The specific function connected is selected by the GPIO Alternate Function Registers (AFR).
    
    The ``Additional Functions'' column lists pin capabilities while in analog mode. These are discussed in a later lab which introduces the analog peripherals of the STM32F0.


%    Using a 64-pin LQFP (LQFP64)
%    Table 13. STM32F072x8/xB pin definitions
%    Only have pins that have physical pin numbers under the LQFP64 column. Table lists pin assignments for all chip packages the STM32F072 device is produced in.
%    Alternate functions listed, will be talking about other columns of table in later labs.
%    
%    (marked Figure of table 13, package column highlighted, pin name and possible alternate functions)
    \begin{figure}[]
        \centering\includegraphics[width=0.8\textwidth]{chip_pins}
        \caption{Subset of table 13 - STM32F072x8/xB Datasheet}
        \label{chip_pins}
    \end{figure}

    \begin{example}[Finding Pins With an Alternate Function]
        \label{example2}
            This example demonstrates selecting a pin which connects to the fourth capture/compare channel of timer 3. 
            
            Begin by browsing through the alternate functions column in Table 13 until you find a signal titled ``TIM3\_CH4.'' The names of alternate functions always begin with an abbreviation of their peripheral, followed by a short designator which is indicated somewhere in the functional description. Figure \ref{chip_pins} shows one of the possible pin choices with the desired function circled in blue. Examining the pin information across the row we can see that this pin belongs to GPIOB (circled in green) and is the 27th physical pin on the LQFP64 package used on the Discovery board (circled in orange).
        
%            Example: Chose arbitrary alternate function for a peripheral and walk through the process of finding pins
    \end{example}
%    (add in section on how to graphically do this with stmcube later)
    
    \subsection{Selecting an Alternate Function}
    Because a pin can only be connected to a single alternate function at a time, the GIPO peripherals have control registers dedicated to selecting between the possibilities. These are the \textit{Alternate Function High Register} (AFRH) and the  \textit{Alternate Function Low Register} (AFRL). 
    
    Within these registers are regions of bits that select alternate functions by their alternate function number for the pin. These function numbers are documented in Tables 14-19 of the \textit{Pinouts and Pin Descriptions} section in the device datasheet. 
%    Demonstrate the AFR registers in the GPIO peripheral
%    Once have pins that can use the AF, need to find what specific AF number it is for that pin.
%    Use tables 14-19 in the chip datasheet
%    
%    (marked figure of table 14-19, pick a GPIO and an alternate function) 

   	
    \begin{example}[Determining an Alternate Function's Number] 
        \label{example3}
Figure \ref{func_pins} shows a portion of Table 15 in the pinouts and pin descriptions section of the device datasheet. This table lists the alternate functions for the GPIOB pins of the device. Continuing from the previous example, we can begin by finding the row representing PB1, the pin chosen with the TIM3\_CH4 function found in Table 13. 

Looking across the columns of the PB1 row lists the same alternate functions listed in Table 13. The difference in this table is that the column header's indicate an alternate function number. Finding the TIM3\_CH4 (circled in blue), we can look up to the column header and see the alternate function number is ``AF1.'' (circled in red)

By programming the bit pattern for AF1 into the bit region representing PB1 in the GPIOB alternate function registers we can select the capture/compare channel 4 of timer 3 to output on that pin. You will need to read the register map for the GPIO AFRH \& AFRL registers, as well as check the peripheral header files to see how the GPIO structure defines them.  
%         Example: Find AF number and select for pin in previous example.
    \end{example}

    \begin{figure}[]
    \centering\includegraphics[width=\textwidth]{func_pins}
    \caption{Subset of table 15 - STM32F072x8/xB Datasheet}
    \label{func_pins}
\end{figure}
    
\section{\color{blue}Lab Assignment}
    
\begin{exercise}[Configuring Pin Alternate Functions] 
    All four of the LEDs on the Discovery board connect to timer capture/compare channels. This enables us to control their apparent brightness using PWM. In the previous exercise you used two of the LEDs in timer 2's interrupt. For this portion of the lab, you'll use the remaining two. 
    
    \begin{enumerate}
        \item Look up the alternate functions of the red (PC6) and blue (PC7) LEDs by following examples \ref{example2} and \ref{example3}. 
        \begin{itemize}
            \item Alternate functions that connect to the capture/compare channels of timers have the form: ``TIMx\_CHy''.
        \end{itemize}
        \item Configure the LED pins to alternate function mode, and select the appropriate function number in alternate function registers.
        \begin{itemize}
            \item Alternate function numbers for each pin are listed in table 15 of the device datasheet.
            \item The alternate function registers are defined as an array in \textit{stm32f0xb.h}. You'll need to check the register map in the peripheral manual to determine what alternate function register to modify for the pins you are using. 
        \end{itemize}
        \item Although we configured the matching capture/compare channels first in this lab, typically you choose pins first and then work with the timer channels available. 
        \item Compile and load your application onto the Discovery board. 
    \end{enumerate} 
\end{exercise}    
    
\begin{assignment}
	Please show the TA that your red and blue LEDs dim and brighten according to the duty cycle. Make sure that your passoff gets recorded on the passoff spreadsheet!
\end{assignment}
    
\begin{exercise}[Measuring PWM Output]
    In exercise \ref{ex2} you configured channel 1 to \textit{PWM mode 2} and channel 2 to \textit{PWM mode 1}. In this exercise you will be exploring the difference between the two modes and the effect of the CCRx register on the output duty cycle. 
    
    \begin{enumerate}
        \item Connect the Saleae logic analyzer to pins PC6 and PC7, and start a capture with the PWM running.
        \item Considering that both channels have their CCRx values set to 20\% of the ARR, what is the difference between the two PWM modes?
        \item Experiment with a variety of CCRx values for both channels. 
        \begin{itemize}
            \item What does increasing the CCRx value do for each PWM mode?
            \item The maximum value that an be used in the CCRx register is the ARR value. What is the relationship between PWM duty cycle and the CCRx, ARR registers?
        \end{itemize}
    \item Take a screenshot of the effect of the duty cycle on the waveform using your logic analyzer; include this screenshot with your postlab submission.
    \end{enumerate}
    
\end{exercise}


\section{\color{blue}Postlab Questions}\index{Postlab Questions}
\begin{question}[Postlab 3]
	Please answer the following questions and hand in as your postlab for Lab 3.
	% The section locations for each question needs renumbering in respect to the section to which it refers
	\begin{enumerate}
		\item Using a timer clock source of 8 MHz, calculate PSC and ARR values to get a 60 Hz interrupt.
		\begin{itemize}
			\item This is tricky because precisely 60 Hz is impossible with our system; instead, think about the process and minimize the error. Many combinations of PSC and ARR values work\textemdash not just one!
		\end{itemize}
		\item Look through the Table 13 "STM32F072x8/xB pin definitions" in the chip datasheet and list all pins that can have the timer 3 capture/compare channel 1 alternate function.
		\begin{itemize}
			\item If the pin is included on the LQFP64 package that we are using, list the alternate function number that you would use to select it.
		\end{itemize}
		\item List your measured value of the timer UEV interrupt period from first experiment.
		\item Describe what happened to the measured duty-cycle as the CCRx value increased in PWM mode 1.
		\item Describe what happened to the measured duty-cycle as the CCRx value increased in PWM mode 2.
		\item Include at least one logic analyzer screenshot of a PWM capture. 
		\item What PWM mode is shown in figure \ref{pwm_pin} of the lab manual (PWM mode 1 or 2)?
	\end{enumerate}
\end{question}


%\section{Lab Assignment:}
%Tn these exercises you will be working with one or more timer peripherals in the STM32F0. You are free to use any timer you wish for the first portion on timer interrupts. However, since the timers are only routed to a limited selection of pins, you won't have a choice what timers to use for the exercises that generate PWM.  
%Because the final exercise combines the two previous ones, you may wish to use the same timer for all three activities. This is possible but requires more thought when choosing timer prescaler and other attributes so that the timer operation is suitable for both tasks. It is far easier to use two separate timers, one for the longer period interrupt, the other for the short period PWM. 
%
%\subsection{Using a Timer Interrupt}
%In this exercise, you'll set up a timer such that the update event (UEV) triggers an interrupt at a specific period. Using a timer peripheral allows for much greater flexibility in choosing an interrupt period over manually counting in the SysTick handler. Section \ref{timer_interrupts} provides the background information on how a timer needs to be configured to produce UEV interrupts. However, you will need to carefully read through the control register maps in the peripheral reference manual to determine the proper option bits to set. 
%
%\begin{itemize}
%    \item Select one of the available timers and enable in the RCC.
%    \begin{itemize}
%        \item You may wish to jump ahead and find the timer that is connected to the LED pins and avoid using that one. 
%        \item Check the alternate functions of the LED pins to determine what timer is connected.
%    \end{itemize}
%    \item Configure the timer such that it triggers an UEV interrupt at 4 Hz.
%    \begin{itemize}
%        \item \textbf{The default processor frequency of the STM32F072 is 8 MHz. Use this value when calculating the timer parameters.}
%        \item Don't forget to enable the UEV interrupt condition in the timer. 
%        \item The timer will only have a single generic interrupt. (not a specific interrupt about the UEV) Look for one named after the timer you are using. 
%        \item Note that you shouldn't enable a timer until you've finished setting all the basic parameters and options. (\underline{Not} referring to the RCC enable, always enable the peripheral clock in the RCC first!)
%    \end{itemize}
%    \item Do something with two LEDs in the interrupt handler. Leave the other two lights free for the other exercise. 
%     \begin{itemize}
%         \item Don't forget to clear the UEV pending flag in the timer peripheral. 
%     \end{itemize}
%     \item Once you have the interrupt running, use a Saleae Logic to measure the period between LED toggles.
%     \begin{itemize}
%         \item Verify that the measured period is similar to what was expected. (Won't be exact due to context switch overhead, instruction execution etc.)
%         \item Include the measured value in your postlab.
%     \end{itemize}
%\end{itemize}
%
%
%\subsection{Generating PWM with a Capture/Compare Unit}
%In this exercise you will set up PWM output to dim a LED on the discovery board. By changing the duty-cycle of the generated waveform you can directly control the apparent brightness of the LED. For this exercise you will need to find the specific timer and capture/compare channels that connect to the unused LED pins. 
%
%The lab manual mentioned that the frequency of a PWM signal isn't nearly as important as the duty-cycle, provided that the frequency is high enough that the system can't directly respond to the on-off periods. This is true when dimming LEDs, although the lower-limit isn't how fast the LED can respond to the electrical signal, but how fast the human eye can distinguish separate blinks of the LED.
%When both the light and viewer are stationary, the human eye has difficulty seeing the blinking transitions past 70 Hz. However, many people can see noticeable flicker in moving lights even above 500 Hz. Because of this, you'll be using 800 Hz as the base frequency for the PWM. 
%
%\begin{itemize}
%    \item Find the timer that has its capture/compare channels connected to the unused LEDs. 
%    \item Configure the LED pins in the GPIO peripheral to alternate function mode, and select the timer's capture/compare alternate function.
%    \item Configure the timer to have a UEV period of 800 Hz, but \underline{don't} enable the UEV interrupt. (not using the interrupt)  
%    \begin{itemize}
%        \item Set the prescaler such that you have a reasonable range of counter values between zero and the top limit. Otherwise your timer will be too granular to be able to make fine adjustments to the duty-cycle of the PWM.
%    \end{itemize}
%    
%    \item Configure the appropriate capture/compare channels that connect to the LED pins to \underline{\textit{PWM mode 1}}. 
%    \item Set the capture/compare register to the following values and observe the results using a logic analyzer:
%    \begin{itemize}
%        \item 25\% the value of the ARR register
%        \item 50\% the value of the ARR register
%        \item 75\% the value of the ARR register
%    \end{itemize}
%    \item Make sure to note the general behavior and change in duty-cycle for your postlab.
%    \item Change the capture/compare channels connecting to the LED pins to \underline{\textit{PWM mode 2}}.  
%    \begin{itemize}
%        \item Repeat the same steps performed above with the new mode.
%    \end{itemize}        
%    \item Take a screenshot of one of the logic captures and include in your postlab. 
%\end{itemize}
%
%
%\subsection{Building an LED Crossfader}
%This final exercise uses the concepts of both the previous experiments to build a fun example. In this section, you'll set up two LEDs such that one of them will fade dimmer over time, while the other fades brighter. Once the limits have been hit, the fade direction will reverse and repeat. 
%
%\begin{itemize}
%    \item Set up the timer and GPIO to PWM two LEDs.
%    \item Set up a longer-period timer interrupt. (the one used in the first experiment is fine)
%    \item Set the PWM duty-cycles so that one LED is bright and the other is off.
%    \item Incrementally modify the PWM duty-cycles in the timer interrupt, such that the brightness of both LEDs fade in opposite directions. 
%    \begin{itemize}
%        \item Once the end limits have been reached, reverse the direction
%        \item You can either keep separate variables tracking the direction and value of each capture/compare channel, or set the PWM modes such that only a single value is necessary.
%    \end{itemize}
%\end{itemize}
 

\end{document}
